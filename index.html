<!DOCTYPE html>
<html lang="it">
<head>
    <title>Nation Pixel Project</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        h1 { color: #333; }
        #map { width: 80%; height: 600px; margin: 20px auto; border: 1px solid #ccc; }
        .leaflet-popup-content { text-align: center; }
        button { padding: 5px 10px; margin-top: 10px; cursor: pointer; }
        .logo-preview { max-width: 100px; max-height: 100px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Compra una Nazione!</h1>
    <p>Acquista una nazione e carica il tuo logo.</p>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="nations.js"></script>
    <script>
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © OpenStreetMap contributors'
        }).addTo(map);

        function calculatePixels(area) {
            return Math.ceil(area / 100); // 1 pixel = 100 km²
        }

        // Oggetto per tenere traccia delle nazioni acquistate
        let purchasedNations = JSON.parse(localStorage.getItem('purchasedNations')) || {};

        // Funzione per salvare lo stato delle nazioni
        function savePurchasedNations() {
            localStorage.setItem('purchasedNations', JSON.stringify(purchasedNations));
        }

        // Funzione per convertire GeoJSON in SVG path
        function geojsonToPath(geojson) {
            let pathData = '';
            const coordinates = geojson.coordinates;

            if (geojson.type === 'Polygon') {
                coordinates.forEach(polygon => {
                    polygon.forEach((point, index) => {
                        const latlng = L.latLng(point[1], point[0]);
                        const pixelPoint = map.latLngToLayerPoint(latlng);
                        pathData += (index === 0 ? 'M' : 'L') + `${pixelPoint.x},${pixelPoint.y}`;
                    });
                    pathData += 'Z';
                });
            } else if (geojson.type === 'MultiPolygon') {
                coordinates.forEach(multi => {
                    multi.forEach(polygon => {
                        polygon.forEach((point, index) => {
                            const latlng = L.latLng(point[1], point[0]);
                            const pixelPoint = map.latLngToLayerPoint(latlng);
                            pathData += (index === 0 ? 'M' : 'L') + `${pixelPoint.x},${pixelPoint.y}`;
                        });
                        pathData += 'Z';
                    });
                });
            }
            return pathData;
        }

        fetch('custom.geo.json')
            .then(response => {
                if (!response.ok) throw new Error('Errore nel caricamento del JSON');
                return response.json();
            })
            .then(data => {
                // Layer per le nazioni non acquistate
                L.geoJSON(data, {
                    style: function(feature) {
                        var name = feature.properties.name;
                        var isPurchased = purchasedNations[name] && purchasedNations[name].purchased;
                        return {
                            color: "#ff7800",
                            weight: 1,
                            fillOpacity: isPurchased ? 0 : 0.5, // Nascondi il riempimento se acquistata
                            fillColor: "#ff7800"
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        var name = feature.properties.name || "Nazione sconosciuta";
                        var area = nationData[name] || 1000;
                        var pixels = calculatePixels(area);
                        var isPurchased = purchasedNations[name] && purchasedNations[name].purchased;

                        // Contenuto del popup
                        var popupContent = `
                            <b>${name}</b><br>
                            Pixel: ${pixels}<br>
                            Costo: $${pixels}<br>
                            Stato: ${isPurchased ? 'Acquistata' : 'Disponibile'}
                        `;
                        if (!isPurchased) {
                            popupContent += `
                                <br><button onclick="buyNation('${name}', ${pixels})">Compra</button>
                            `;
                        } else if (purchasedNations[name].logo) {
                            popupContent += `
                                <br><img src="${purchasedNations[name].logo}" class="logo-preview" alt="Logo">
                                <br><button onclick="changeLogo('${name}')">Cambia Logo</button>
                            `;
                        } else {
                            popupContent += `
                                <br><button onclick="changeLogo('${name}')">Carica Logo</button>
                            `;
                        }

                        layer.bindPopup(popupContent);

                        // Se la nazione è acquistata e ha un logo, aggiungi un overlay SVG
                        if (isPurchased && purchasedNations[name].logo) {
                            const bounds = layer.getBounds();
                            const svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            svgElement.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                            svgElement.setAttribute('viewBox', '0 0 1000 1000');

                            // Crea un pattern con il logo
                            const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
                            pattern.setAttribute('id', `pattern-${name}`);
                            pattern.setAttribute('width', '100%');
                            pattern.setAttribute('height', '100%');
                            pattern.setAttribute('patternUnits', 'objectBoundingBox');

                            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                            image.setAttribute('href', purchasedNations[name].logo);
                            image.setAttribute('width', '1000');
                            image.setAttribute('height', '1000');
                            pattern.appendChild(image);

                            // Crea il percorso della nazione
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            path.setAttribute('d', geojsonToPath(feature.geometry));
                            path.setAttribute('fill', `url(#pattern-${name})`);
                            path.setAttribute('stroke', '#ff7800');
                            path.setAttribute('stroke-width', '1');

                            svgElement.appendChild(pattern);
                            svgElement.appendChild(path);

                            L.svgOverlay(svgElement, bounds).addTo(map);
                        }
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Errore:', error));

        // Funzione per "comprare" una nazione
        function buyNation(name, pixels) {
            if (confirm(`Vuoi comprare ${name} per $${pixels}?`)) {
                purchasedNations[name] = { purchased: true, logo: null };
                savePurchasedNations();
                alert('Nazione acquistata! Ora puoi caricare un logo.');
                changeLogo(name);
                location.reload();
            }
        }

        // Funzione per caricare o cambiare il logo
        function changeLogo(name) {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                var file = event.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        purchasedNations[name].logo = e.target.result;
                        savePurchasedNations();
                        alert('Logo caricato con successo!');
                        location.reload();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Aggiorna gli overlay SVG quando la mappa si muove
        map.on('moveend', function() {
            location.reload(); // Ricarica per aggiornare le posizioni SVG
        });
    </script>
</body>
</html>
